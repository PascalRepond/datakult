name: CI

on:
  push:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: src/theme/static_src/package-lock.json

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install Python dependencies
        run: uv sync --frozen

      - name: Install Node.js dependencies
        run: npm ci
        working-directory: src/theme/static_src

      - name: Run CI checks
        run: uv run poe ci

  release-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --frozen

      - name: Validate release configuration
        run: |
          echo "üìã Checking what release would be created..."
          echo ""

          # Run in noop mode to see what would happen without making changes
          uv run semantic-release --noop version || {
            echo "‚ÑπÔ∏è  No release would be created (no releasable commits since last release)"
            exit 0
          }

          echo ""
          echo "‚úÖ Release configuration is valid!"
