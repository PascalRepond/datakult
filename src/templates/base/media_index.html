{% extends "base/base.html" %}
{% load i18n %}
{% load static %}
{% load media_tags %}
{% block title %}
  Datakult
{% endblock title %}
{% block content %}
  <div class="flex items-baseline gap-4 my-4">
    <h1 class="text-4xl">{% translate "My media" %}</h1>
    <span class="text-sm text-base-content/70">
      {{ page_obj.paginator.count }}
      {% if page_obj.paginator.count > 1 %}
        {% translate "items" %}
      {% else %}
        {% translate "item" %}
      {% endif %}
    </span>
  </div>
  <div class="flex flex-col gap-4">
    {# Top bar with search and controls #}
    <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 items-stretch sm:items-center">
      {# Search bar - takes remaining space #}
      <form method="get" action="{% url 'home' %}" class="flex-1 order-1">
        {# Hidden fields to preserve current state #}
        <input type="hidden" name="view_mode" value="{{ view_mode }}" />
        <input type="hidden" name="sort" value="{{ sort }}" />
        <input type="hidden"
               name="contributor"
               value="{{ contributor.id|default:'' }}" />
        <input type="hidden" name="tag" value="{{ tag.id|default:'' }}" />
        {% for type_val in filters.type %}<input type="hidden" name="type" value="{{ type_val }}" />{% endfor %}
        {% for status_val in filters.status %}<input type="hidden" name="status" value="{{ status_val }}" />{% endfor %}
        {% for score_val in filters.score %}<input type="hidden" name="score" value="{{ score_val }}" />{% endfor %}
        {% if filters.review_from %}<input type="hidden" name="review_from" value="{{ filters.review_from }}" />{% endif %}
        {% if filters.review_to %}<input type="hidden" name="review_to" value="{{ filters.review_to }}" />{% endif %}
        {% if filters.has_review %}<input type="hidden" name="has_review" value="{{ filters.has_review }}" />{% endif %}
        {% if filters.has_cover %}<input type="hidden" name="has_cover" value="{{ filters.has_cover }}" />{% endif %}
        <label class="input w-full flex items-center gap-2">
          <input type="search"
                 class="grow"
                 placeholder="{% translate "Search" %}"
                 name="search"
                 value="{{ request.GET.search|default:'' }}"
                 id="search-input" />
          {% if request.GET.search %}
            <a href="?{% query_string_exclude request 'search' %}"
               class="btn btn-ghost btn-sm btn-circle"
               title="{% translate "Clear search" %}">{% lucide "x" %}</a>
          {% endif %}
          <button type="submit" class="btn btn-ghost btn-sm btn-circle">{% lucide "search" size="16" %}</button>
        </label>
      </form>
      {# Right controls group #}
      <div class="flex gap-2 order-2 flex-wrap sm:flex-nowrap">
        {# View mode toggle #}
        {% include "partials/navigation/view_mode_toggle.html" %}
        {# Sort selector #}
        <div class="flex join items-center">
          <a href="?{% query_string request sort=sort|toggle_sort_direction %}"
             class="btn join-item btn-sm sm:btn-md">
            {% if sort|slice:":1" == '-' %}
              {% lucide "arrow-down-narrow-wide" %}
            {% else %}
              {% lucide "arrow-up-wide-narrow" %}
            {% endif %}
          </a>
          <select class="select join-item select-sm sm:select-md"
                  id="sort-field-select"
                  onchange="window.location.href = '?{% query_string_exclude request 'sort' 'sort_field' %}&sort=' + (this.value.startsWith('-') ? this.value : '{% if sort|slice:":1" == "-" %}-{% endif %}' + this.value)">
            <option value="score" {% if sort_field == 'score' %}selected{% endif %}>{% translate "Score" %}</option>
            <option value="review_date"
                    {% if sort_field == 'review_date' %}selected{% endif %}>{% translate "Review date" %}</option>
            <option value="created_at"
                    {% if sort_field == 'created_at' %}selected{% endif %}>{% translate "Creation date" %}</option>
            <option value="updated_at"
                    {% if sort_field == 'updated_at' %}selected{% endif %}>{% translate "Update date" %}</option>
          </select>
        </div>
        {# Filters button - opens drawer #}
        <label for="filters-drawer" class="btn btn-sm sm:btn-md" type="button">
          {% lucide "filter" %}
          <span class="hidden sm:inline">{% translate "Filters" %}</span>
        </label>
        {# Add button #}
        <a href="{% url 'media_import' %}"
           class="btn btn-primary btn-sm sm:btn-md">
          {% lucide "plus" %}
          <span class="hidden sm:inline">{% translate "Add" %}</span>
        </a>
      </div>
    </div>
    {# Active filters badges #}
    <div id="active-filters-badges" class="flex flex-wrap gap-2 items-center">
      {% if filters.type %}
        {% for type_val, type_label in filters.type_display %}
          {% include "partials/filters/filter_badge.html" with label=type_label filter_name="type" filter_value=type_val %}
        {% endfor %}
      {% endif %}
      {% if filters.status %}
        {% for status_val, status_label in filters.status_display %}
          {% include "partials/filters/filter_badge.html" with label=status_label filter_name="status" filter_value=status_val %}
        {% endfor %}
      {% endif %}
      {% if filters.score %}
        {% for score_val, score_label in filters.score_display %}
          {% include "partials/filters/filter_badge.html" with label=score_label filter_name="score" filter_value=score_val %}
        {% endfor %}
      {% endif %}
      {% if filters.review_from or filters.review_to %}
        {% with review_label="ðŸ“… "|add:filters.review_from|default:""|add:" â†’ "|add:filters.review_to|default:"" %}
          {% include "partials/filters/filter_badge.html" with label=review_label filter_name="review" %}
        {% endwith %}
      {% endif %}
      {% if filters.has_review %}
        {% if filters.has_review == 'empty' %}
          {% translate "No review" as has_review_label %}
        {% else %}
          {% translate "Has review" as has_review_label %}
        {% endif %}
        {% include "partials/filters/filter_badge.html" with label=has_review_label filter_name="has_review" %}
      {% endif %}
      {% if filters.has_cover %}
        {% if filters.has_cover == 'empty' %}
          {% translate "No cover" as has_cover_label %}
        {% else %}
          {% translate "Has cover" as has_cover_label %}
        {% endif %}
        {% include "partials/filters/filter_badge.html" with label=has_cover_label filter_name="has_cover" %}
      {% endif %}
      {% if contributor %}
        {% include "partials/filters/filter_badge.html" with label=contributor.name filter_name="contributor" badge_id="contributor-badge" label_id="contributor-badge-name" %}
      {% endif %}
      {% if tag %}
        {% include "partials/filters/filter_badge.html" with label=tag.name filter_name="tag" badge_id="tag-badge" label_id="tag-badge-name" %}
      {% endif %}
      {# Save view button - only shown when filters are active #}
      {% if filters.has_any or contributor or tag %}
        <label for="save-view-modal"
               class="btn btn-sm btn-ghost gap-2"
               type="button">
          {% lucide "bookmark" %}
          {% translate "Save view" %}
        </label>
      {% endif %}
    </div>
  </div>
  {# Filters drawer #}
  {% include "partials/navigation/filters_drawer.html" %}
  {# Save view modal #}
  {% include "partials/saved_views/save_view_modal.html" %}
  {% include "partials/media_items/media_list.html" %}
{% endblock content %}
