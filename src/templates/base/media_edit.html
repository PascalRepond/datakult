{% extends "base/base.html" %}
{% load i18n %}
{% load static %}
{% block title %}
  {% if media %}
    {% translate "Edit" %} {{ media.title }} - Datakult
  {% else %}
    {% translate "Add media" %}
  {% endif %}
{% endblock title %}
{% block extra_css %}
  {{ form.media.css }}
  <link rel="stylesheet" href="{% static 'css/easymde.css' %}">
{% endblock extra_css %}
{% block head_js %}
  {{ form.media.js }}
{% endblock head_js %}
{% block extra_js %}
  <script src="{% static 'js/media_edit.js' %}"></script>
{% endblock extra_js %}
{% block content %}
  <div class="max-w-4xl mx-auto">
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      {# Header #}
      <div class="flex justify-between items-start gap-4 mb-6">
        <div class="flex-1">
          {% include "partials/common/back_button.html" %}
          <h1 class="text-4xl font-bold">
            {% if media %}
              {% translate "Edit" %} {{ media.title }}
            {% else %}
              {% translate "Add media" %}
            {% endif %}
          </h1>
        </div>
        <div class="flex gap-2">
          <a href="{% url 'media_import' %}{% if media %}?media_id={{ media.pk }}&media_type={{ media.media_type }}&title={{ media.title|urlencode }}{% endif %}"
             class="btn btn-outline btn-sm"
             title="{% translate 'Import metadata' %}">
            {% lucide "download" class="w-4 h-4" %}
            {% translate "Import" %}
          </a>
          <button type="submit" class="btn btn-primary">
            {% lucide "save" %}
            {% translate "Save" %}
          </button>
        </div>
      </div>
      <input type="hidden"
             name="import_cover_url"
             id="import-cover-url"
             value="{{ import_data.cover_url|default:'' }}">
      {# Main content #}
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {# Left column - Cover and metadata #}
        <div class="md:col-span-1 space-y-4">
          {# Cover card #}
          <div class="card bg-base-200 shadow-md">
            <div class="card-body p-4">
              <div class="form-control">
                <label class="label" for="id_cover">
                  {% include "partials/common/field_label.html" with label=_("Cover image") field=form.cover %}
                </label>
                {% if import_data.cover_url %}
                  <div class="mb-2">
                    <img src="{{ import_data.cover_url }}"
                         alt="{% translate 'Imported cover' %}"
                         class="w-full rounded-lg"
                         id="import-poster-preview">
                    <p class="text-xs text-base-content/60 mt-1">
                      {% if media.cover %}
                        {% translate "This will replace the current cover" %}
                      {% else %}
                        {% translate "Cover will be imported" %}
                      {% endif %}
                    </p>
                    <details class="mt-2">
                      <summary class="text-xs link link-hover cursor-pointer">{% translate "Upload a different image instead" %}</summary>
                      <div class="mt-2">{{ form.cover }}</div>
                    </details>
                  </div>
                {% else %}
                  {{ form.cover }}
                {% endif %}
                <label class="label" id="error-cover">
                  {% if form.cover.errors %}<span class="label-text-alt text-error">{{ form.cover.errors.0 }}</span>{% endif %}
                </label>
              </div>
            </div>
          </div>
          {# Metadata card #}
          <div class="card bg-base-200 shadow-md">
            <div class="card-body p-4 space-y-2">
              <div class="form-control">
                <label class="label" for="id_title">
                  {% include "partials/common/field_label.html" with label=_("Title") field=form.title %}
                </label>
                {{ form.title }}
                <label class="label" id="error-title">
                  {% if form.title.errors %}<span class="label-text-alt text-error">{{ form.title.errors.0 }}</span>{% endif %}
                </label>
              </div>
              <div class="form-control">
                <label class="label" for="id_contributors">
                  {% include "partials/common/field_label.html" with label=_("Contributors") field=form.contributors %}
                </label>
                <div id="contributors-chips" class="flex flex-wrap gap-2 mb-2">
                  {# Existing contributors (from database) #}
                  {% for contributor in media.contributors.all %}
                    {% include "partials/contributors/contributor_chip.html" with agent=contributor %}
                  {% endfor %}
                  {# Imported contributors (pre-filled as new) #}
                  {% for name in import_contributors %}
                    <span class="badge badge-lg badge-primary gap-2" data-name="{{ name }}">
                      {{ name }}
                      <button type="button"
                              class="btn btn-ghost btn-xs btn-circle"
                              data-action="remove-chip">✕</button>
                      <input type="hidden" name="new_contributors" value="{{ name }}">
                    </span>
                  {% endfor %}
                </div>
                <div class="relative">
                  <input type="text"
                         id="contributor_search"
                         name="contributor_search"
                         class="input w-full"
                         placeholder="{% translate "Type to search, press Enter to add" %}"
                         autocomplete="off"
                         hx-get="{% url 'agent_search_htmx' %}"
                         hx-trigger="keyup changed delay:300ms"
                         hx-target="#contributor-suggestions"
                         hx-vals='js:{q: document.getElementById("contributor_search").value}' />
                  <div id="contributor-suggestions"
                       class="absolute top-full left-0 right-0 z-50 hidden"></div>
                </div>
                {% if form.contributors.errors %}
                  <label class="label" id="error-contributors">
                    <span class="label-text-alt text-error">{{ form.contributors.errors.0 }}</span>
                  </label>
                {% endif %}
              </div>
              <div class="form-control">
                <label class="label" for="id_tags">
                  {% include "partials/common/field_label.html" with label=_("Tags") field=form.tags %}
                </label>
                <div id="tags-chips" class="flex flex-wrap gap-2 mb-2">
                  {# Existing tags (from database) #}
                  {% for tag in media.tags.all %}
                    {% include "partials/tags/tag_chip.html" %}
                  {% endfor %}
                  {# Imported tags (pre-filled as new) #}
                  {% for name in import_tags %}
                    <span class="badge badge-lg badge-secondary gap-2" data-name="{{ name }}">
                      {{ name }}
                      <button type="button"
                              class="btn btn-ghost btn-xs btn-circle"
                              data-action="remove-chip">✕</button>
                      <input type="hidden" name="new_tags" value="{{ name }}">
                    </span>
                  {% endfor %}
                </div>
                <div class="relative">
                  <input type="text"
                         id="tag_search"
                         name="tag_search"
                         class="input w-full"
                         placeholder="{% translate 'Type to search, press Enter to add' %}"
                         autocomplete="off"
                         hx-get="{% url 'tag_search_htmx' %}"
                         hx-trigger="keyup changed delay:300ms"
                         hx-target="#tag-suggestions"
                         hx-vals='js:{q: document.getElementById("tag_search").value}' />
                  <div id="tag-suggestions"
                       class="absolute top-full left-0 right-0 z-50 hidden"></div>
                </div>
                {% if form.tags.errors %}
                  <label class="label" id="error-tags">
                    <span class="label-text-alt text-error">{{ form.tags.errors.0 }}</span>
                  </label>
                {% endif %}
              </div>
              <div class="form-control">
                <label class="label" for="id_media_type">
                  {% include "partials/common/field_label.html" with label=_("Media type") field=form.media_type %}
                </label>
                {{ form.media_type }}
                <label class="label" id="error-media_type">
                  {% if form.media_type.errors %}
                    <span class="label-text-alt text-error">{{ form.media_type.errors.0 }}</span>
                  {% endif %}
                </label>
              </div>
              <div class="form-control">
                <label class="label" for="id_pub_year">
                  {% include "partials/common/field_label.html" with label=_("Release year") field=form.pub_year %}
                </label>
                {{ form.pub_year }}
                <label class="label" id="error-pub_year">
                  {% if form.pub_year.errors %}<span class="label-text-alt text-error">{{ form.pub_year.errors.0 }}</span>{% endif %}
                </label>
              </div>
              <div class="form-control">
                <label class="label" for="id_external_uri">
                  {% include "partials/common/field_label.html" with label=_("External URI") field=form.external_uri %}
                </label>
                {{ form.external_uri }}
                <label class="label" id="error-external_uri">
                  {% if form.external_uri.errors %}
                    <span class="label-text-alt text-error">{{ form.external_uri.errors.0 }}</span>
                  {% endif %}
                </label>
              </div>
            </div>
          </div>
        </div>
        {# Right column - Personal data and review #}
        <div class="md:col-span-2 space-y-4">
          {# Personal data card #}
          <div class="card bg-base-200 shadow-md">
            <div class="card-body p-4 space-y-2">
              <div class="form-control">
                <label class="label" for="id_score">
                  {% include "partials/common/field_label.html" with label=_("Score") field=form.score %}
                </label>
                {{ form.score }}
                <label class="label" id="error-score">
                  {% if form.score.errors %}<span class="label-text-alt text-error">{{ form.score.errors.0 }}</span>{% endif %}
                </label>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="form-control">
                  <label class="label" for="id_status">
                    {% include "partials/common/field_label.html" with label=_("Status") field=form.status %}
                  </label>
                  {{ form.status }}
                  <label class="label" id="error-status">
                    {% if form.status.errors %}<span class="label-text-alt text-error">{{ form.status.errors.0 }}</span>{% endif %}
                  </label>
                </div>
                <div class="form-control">
                  <label class="label" for="id_review_date">
                    <span>{% include "partials/common/field_label.html" with label=_("Review date") field=form.review_date %}</span>
                    <button type="button"
                            id="set-today-btn"
                            class="btn btn-xs btn-ghost gap-1"
                            title="{% translate "Set to today" %}">
                      {% lucide "calendar" size="16" %}
                      {% translate "Today" %}
                    </button>
                  </label>
                  {{ form.review_date }}
                  <label class="label" id="error-review_date">
                    {% if form.review_date.errors %}
                      <span class="label-text-alt text-error">{{ form.review_date.errors.0 }}</span>
                    {% endif %}
                  </label>
                </div>
              </div>
            </div>
          </div>
          {# Review card #}
          <div class="card bg-base-200 shadow-md">
            <div class="card-body p-4">
              <div class="form-control">
                <label class="label" for="id_review">
                  {% include "partials/common/field_label.html" with label=_("Review") field=form.review %}
                </label>
                {{ form.review }}
                <label class="label" id="error-review">
                  {% if form.review.errors %}<span class="label-text-alt text-error">{{ form.review.errors.0 }}</span>{% endif %}
                </label>
              </div>
            </div>
          </div>
          {# Actions card #}
          {% if media %}
            <div class="card bg-base-200 shadow-md">
              <div class="card-body p-4">
                <label for="confirm-delete-modal" class="btn btn-error w-full">
                  {% lucide "trash" %}
                  {% translate "Delete" %}
                </label>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </form>
    {% if media %}
      <form id="delete-form"
            class="hidden"
            method="post"
            action="{% url 'media_delete' media.pk %}">
        {% csrf_token %}
      </form>
      {# Confirmation modal for media deletion #}
      {% include "partials/common/confirm_modal.html" with modal_id="confirm-delete-modal" title=_("Delete Media") message=_("Are you sure you want to delete this media? This action cannot be undone.") confirm_text=_("Yes, delete") is_danger=True form_id="delete-form" %}
    {% endif %}
  </div>
{% endblock content %}
