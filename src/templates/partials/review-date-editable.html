{% load i18n %}
<div id="review-date-widget-{{ media.id }}" class="inline-block">
  <div class="review-date-display cursor-pointer hover:opacity-80 transition-opacity">
    {% if media.review_date %}
      <span class="text-sm">{{ media.review_date }}</span>
    {% else %}
      <span class="text-sm text-base-content/50">{% translate "No date" %}</span>
    {% endif %}
  </div>

  <div class="review-date-edit hidden">
    <div class="flex flex-col gap-1">
      <input type="text"
             class="input input-xs input-bordered w-32"
             name="review_date"
             value="{{ media.review_date|default:'' }}"
             placeholder="{% translate "YYYY-MM-DD" %}"
             hx-post="{% url 'media_update_review_date_htmx' media.id %}"
             hx-target="#review-date-widget-{{ media.id }}"
             hx-swap="outerHTML"
             hx-trigger="blur[!this.classList.contains('input-error')] delay:200ms">
      <button type="button" class="btn btn-xs btn-link text-xs review-date-today-btn">
        {% translate "Today" %}
      </button>
      <span class="text-xs text-error hidden review-date-error">{% translate "Invalid format" %}</span>
    </div>
  </div>
</div>

<script>
(function() {
  const widget = document.querySelector('#review-date-widget-{{ media.id }}');
  if (!widget) return;

  const display = widget.querySelector('.review-date-display');
  const edit = widget.querySelector('.review-date-edit');
  const input = widget.querySelector('input[name="review_date"]');
  const todayBtn = widget.querySelector('.review-date-today-btn');
  const errorMsg = widget.querySelector('.review-date-error');

  // Add helper tooltip
  input.setAttribute('title', '{% translate "Formats: YYYY, YYYY-MM, or YYYY-MM-DD" %}');

  // Validate date format
  function isValidDateFormat(value) {
    if (!value) return true; // Empty is valid (clears the date)
    // Match YYYY, YYYY-MM, or YYYY-MM-DD
    const patterns = [
      /^\d{4}$/,                    // YYYY
      /^\d{4}-(0[1-9]|1[0-2])$/,    // YYYY-MM
      /^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/  // YYYY-MM-DD
    ];
    return patterns.some(pattern => pattern.test(value));
  }

  // Show edit mode on click
  display.addEventListener('click', function() {
    display.classList.add('hidden');
    edit.classList.remove('hidden');
    input.focus();
  });

  // Validate on input
  input.addEventListener('input', function() {
    const value = input.value.trim();
    if (value && !isValidDateFormat(value)) {
      input.classList.add('input-error');
      errorMsg.classList.remove('hidden');
    } else {
      input.classList.remove('input-error');
      errorMsg.classList.add('hidden');
    }
  });

  // Handle escape key to cancel editing
  input.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      // Reset to original value and clear error
      input.value = '{{ media.review_date|default:"" }}';
      input.classList.remove('input-error');
      errorMsg.classList.add('hidden');
      edit.classList.add('hidden');
      display.classList.remove('hidden');
    }
  });

  // Insert today's date
  todayBtn.addEventListener('click', function() {
    const today = new Date();
    input.value = today.getFullYear() + '-' +
                  String(today.getMonth() + 1).padStart(2, '0') + '-' +
                  String(today.getDate()).padStart(2, '0');
    input.classList.remove('input-error');
    errorMsg.classList.add('hidden');
    htmx.trigger(input, 'blur');
  });
})();
</script>
