{% load i18n %}
<div id="review-widget-{{ media.id }}">
  {# Display mode #}
  <div class="review-display">
    {% if media.review %}
      <div class="whitespace-pre-line text-sm review-text">{{ media.review | truncatechars:120 }}</div>
      <div class="flex gap-2 mt-1">
        {% if media.review|length > 120 %}
          <button class="btn btn-xs btn-ghost review-see-more-btn">
            {% translate "See more" %}
          </button>
          <button class="btn btn-xs btn-ghost review-see-less-btn hidden">
            {% translate "See less" %}
          </button>
        {% endif %}
        <button class="btn btn-xs btn-primary review-edit-btn">
          {% translate "Edit" %}
        </button>
      </div>
    {% else %}
      <button class="btn btn-xs btn-ghost text-base-content/50 review-add-btn">
        {% translate "Add review" %}
      </button>
    {% endif %}
  </div>

  {# Edit mode #}
  <div class="review-edit hidden">
    <textarea class="textarea textarea-bordered textarea-sm w-full"
              rows="4"
              name="review"
              placeholder="{% translate "Write your review..." %}"
              hx-post="{% url 'media_update_review_htmx' media.id %}"
              hx-target="#review-widget-{{ media.id }}"
              hx-swap="outerHTML"
              hx-trigger="blur delay:200ms">{{ media.review }}</textarea>
    <div class="flex gap-2 mt-1">
      <button type="button" class="btn btn-xs btn-primary review-save-btn">
        {% translate "Save" %}
      </button>
      <button type="button" class="btn btn-xs btn-ghost review-cancel-btn">
        {% translate "Cancel" %}
      </button>
    </div>
  </div>
</div>

<script>
(function() {
  const widget = document.querySelector('#review-widget-{{ media.id }}');
  if (!widget) return;

  const display = widget.querySelector('.review-display');
  const edit = widget.querySelector('.review-edit');
  const textarea = widget.querySelector('textarea[name="review"]');
  const reviewText = widget.querySelector('.review-text');

  // Full and truncated review text
  const fullReview = `{{ media.review|escapejs }}`;
  const truncatedReview = `{{ media.review|truncatechars:120|escapejs }}`;

  // Buttons
  const seeMoreBtn = widget.querySelector('.review-see-more-btn');
  const seeLessBtn = widget.querySelector('.review-see-less-btn');
  const editBtn = widget.querySelector('.review-edit-btn');
  const addBtn = widget.querySelector('.review-add-btn');
  const saveBtn = widget.querySelector('.review-save-btn');
  const cancelBtn = widget.querySelector('.review-cancel-btn');

  // Show full review
  if (seeMoreBtn) {
    seeMoreBtn.addEventListener('click', function() {
      reviewText.textContent = fullReview;
      seeMoreBtn.classList.add('hidden');
      seeLessBtn.classList.remove('hidden');
    });
  }

  // Show truncated review
  if (seeLessBtn) {
    seeLessBtn.addEventListener('click', function() {
      reviewText.textContent = truncatedReview;
      seeLessBtn.classList.add('hidden');
      seeMoreBtn.classList.remove('hidden');
    });
  }

  // Show edit mode from edit button
  if (editBtn) {
    editBtn.addEventListener('click', function() {
      display.classList.add('hidden');
      edit.classList.remove('hidden');
      textarea.focus();
    });
  }

  // Show edit mode from add button
  if (addBtn) {
    addBtn.addEventListener('click', function() {
      display.classList.add('hidden');
      edit.classList.remove('hidden');
      textarea.focus();
    });
  }

  // Save review
  if (saveBtn) {
    saveBtn.addEventListener('click', function() {
      textarea.dispatchEvent(new Event('blur'));
    });
  }

  // Cancel editing
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function() {
      edit.classList.add('hidden');
      display.classList.remove('hidden');
    });
  }

  // Handle escape key to cancel editing
  if (textarea) {
    textarea.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        edit.classList.add('hidden');
        display.classList.remove('hidden');
      }
    });
  }
})();
</script>
